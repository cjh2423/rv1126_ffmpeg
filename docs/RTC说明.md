# 🕒 RTC (实时时钟) 开发说明

本项目在处理录像存储或 OSD 时间戳时，高度依赖系统时间的准确性。对于 RV1126 嵌入式平台，RTC 的正确配置至关重要。

---

## 🧭 基本概念

> [!IMPORTANT]
> - **RTC 时间 (Hardware Clock)**: 由板载 RTC 芯片 (如 `/dev/rtc0`) 维护，由备用电池供电，掉电不丢失。
> - **系统时间 (System Clock)**: Linux 内核维护的时间，开机后从 RTC 读取，随后由内核计时，关机即消失。

---

## 🔄 时间同步流程

标准的嵌入式时间同步逻辑如下：

1. **上电启动**: 系统通过脚本执行 `hwclock -s`，将 RTC 硬件时间同步到内核。
2. **网络校时**: 如果网络可用，启动 `NTP` 服务自动校准内核时间。
3. **持久化**: 定期或在关机前执行 `hwclock -w`，将校准后的内核时间写入 RTC 芯片。

---

## 🛠️ 常用运维命令

### 查看时间
```bash
date       # 查看当前系统时间
hwclock -r # 读取 RTC 硬件时间
```

### 同步与校准
```bash
# 将系统时间同步到硬件 RTC
hwclock -w

# 将硬件 RTC 时间同步到系统
hwclock -s

# 手动设定系统时间
date -s "2025-02-11 12:34:56"
```

---

## 💻 编程开发指南

在 C 代码中，通常建议根据需求选择以下方案：

### 方案 A：使用系统时间 (推荐)
适用于大多数业务逻辑（如文件名命名、日志打印）。
```c
struct timespec ts;
clock_gettime(CLOCK_REALTIME, &ts);
```

### 方案 B：直接访问硬件 RTC
适用于底层校时工具或不依赖内核时钟的特殊场景。
- 涉及打开 `/dev/rtc0` 并通过 `ioctl` 进行操作。

---

## ⚠️ 常见问题 FAQ

**Q: 为什么重启后时间变回了 1970 年？**
A: 请检查开发板是否安装了 RTC 电池。若无电池，掉电后 RTC 芯片会清零。

**Q: 如何验证 RTC 驱动是否正常？**
A: 执行 `dmesg | grep rtc`，查看是否有 `rtc-rk808` 或类似驱动挂载成功的日志。

**Q: RTC 精度不够怎么办？**
A: RTC 存在温漂。建议在有网络的环境下开启 NTP 自动校时，每天凌晨定时执行 `hwclock -w`。
