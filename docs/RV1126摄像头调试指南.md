# RV1126 摄像头调试与开发手册

本文档记录在 RV1126 (Rockchip Linux SDK) 平台上进行摄像头开发时的关键知识点、调试命令及常见问题解决方案。

## 1. 核心概念：V4L2 Multi-plane API

Rockchip 平台的 ISP 驱动 (`rkisp_v4`) 使用了 V4L2 **Multi-plane API**。这与传统的 USB 摄像头（Single-plane）有显著区别。

### 区别对比

| 特性 | Single-plane (常规) | Multi-plane (Rockchip ISP) |
| :--- | :--- | :--- |
| **Capability** | `V4L2_CAP_VIDEO_CAPTURE` | `V4L2_CAP_VIDEO_CAPTURE_MPLANE` |
| **Buffer Type** | `V4L2_BUF_TYPE_VIDEO_CAPTURE` | `V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE` |
| **数据结构** | 使用 `fmt.pix` 和 `buf.length` | 使用 `fmt.pix_mp` 和 `buf.m.planes` |
| **内存映射** | 直接映射 `buf.m.offset` | 映射 `buf.m.planes[i].m.mem_offset` |

**开发注意**：如果不适配 Multi-plane API，代码通常会在 `VIDIOC_QUERYCAP` 或 `VIDIOC_S_FMT` 阶段报错。

---

## 2. 核心概念：Media Controller (Media 拓扑)

RV1126 的 ISP 是一个复杂的流水线，包含传感器 (Sensor)、MIPI 接收器 (DPHY)、ISP 核心、以及多个输出节点 (Mainpath, Selfpath 等)。Linux 使用 **Media Controller API** 来管理这些复杂的链路。

### 关键节点

*   **Sensor**: 图像源 (如 `m00_f_gc2053`)。
*   **/dev/video0 (rkisp_mainpath)**: 主通道，通常用于高分辨率输出。
*   **/dev/video1 (rkisp_selfpath)**: 自通道，通常用于预览或缩放后的输出。
*   **/dev/media0**: 控制节点，用于配置整个拓扑结构。

### 常见陷阱
在某些固件配置中，默认只启用了 `selfpath` (`/dev/video1`)，而 `mainpath` (`/dev/video0`) 的链路是断开的。如果尝试打开未连接的节点，会报 **"Operation not permitted"** 错误。

---

## 3. 常用调试命令

### 3.1 检查设备能力 (v4l2-ctl)

查看设备支持的格式和 API 类型：
```bash
v4l2-ctl --device=/dev/video1 --all
```
*   如果看到 `Video Capture Multiplanar`，说明必须使用 Multi-plane API。

### 3.2 查看 Media 拓扑 (media-ctl)

查看当前 ISP 链路连接情况：
```bash
media-ctl -p -d /dev/media0
```
**重点关注** `[ENABLED]` 标记。例如：
```text
- entity 23: rkisp_selfpath (1 pad, 1 link)
             device node name /dev/video1
        pad0: Sink
                <- "rkisp-isp-subdev":2 [ENABLED]  <-- 启用状态
```

### 3.3 手动启用/切换链路

如果想使用 `/dev/video0` 但它未启用，可以使用以下命令连接链路（注意：sensor 和 ISP 的 entity ID 可能不同，需根据实际情况调整）：
```bash
# 断开 selfpath
media-ctl -d /dev/media0 -l '"rkisp-isp-subdev":2 -> "rkisp_selfpath":0 [0]'
# 连接 mainpath
media-ctl -d /dev/media0 -l '"rkisp-isp-subdev":2 -> "rkisp_mainpath":0 [1]'
```

---

## 4. 常见错误排查 (Troubleshooting)

### Error: `/dev/videoX is no video capture device`
*   **原因**: 代码只检查了 `V4L2_CAP_VIDEO_CAPTURE`，而设备是 `V4L2_CAP_VIDEO_CAPTURE_MPLANE`。
*   **解决**: 修改代码同时检查两种 Capability，并根据结果设置 `buffer_type` 变量。

### Error: `Stream On: Operation not permitted`
*   **原因**: 该 Video 节点的 Media Link 没有连接（Disconnected）。
*   **解决**: 
    1.  使用 `media-ctl -p` 检查哪个节点是 `[ENABLED]` 的（通常是 `/dev/video1`）。
    2.  修改程序使用已启用的节点。
    3.  或者使用 `media-ctl` 命令手动修改链路配置。

### Error: `Invalid argument` (在 VIDIOC_S_FMT 时)
*   **原因**: 设置的像素格式或分辨率 ISP 不支持。
*   **解决**: 先用 `v4l2-ctl --list-formats-ext` 查看支持的列表。RV1126 ISP 通常最喜欢 `NV12` (Format: NV12)。

---

## 5. 代码实现参考 (C语言)

适配 Multi-plane 的关键代码片段：

```c
// 1. 检查能力
struct v4l2_capability cap;
ioctl(fd, VIDIOC_QUERYCAP, &cap);
int use_mplane = (cap.capabilities & V4L2_CAP_VIDEO_CAPTURE_MPLANE) ? 1 : 0;

// 2. 设置格式
struct v4l2_format fmt;
memset(&fmt, 0, sizeof(fmt));
if (use_mplane) {
    fmt.type = V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE;
    fmt.fmt.pix_mp.width = 1920;
    fmt.fmt.pix_mp.height = 1080;
    fmt.fmt.pix_mp.pixelformat = V4L2_PIX_FMT_NV12;
} else {
    fmt.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;
    fmt.fmt.pix.width = 1920;
    // ...
}

// 3. 申请内存
struct v4l2_requestbuffers req;
req.type = use_mplane ? V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE : V4L2_BUF_TYPE_VIDEO_CAPTURE;
// ...

// 4. 内存映射 (mmap)
struct v4l2_plane planes[8];
struct v4l2_buffer buf;
if (use_mplane) {
    buf.m.planes = planes;
    buf.length = 8;
}
ioctl(fd, VIDIOC_QUERYBUF, &buf);

if (use_mplane) {
    // Multi-plane 映射 plane[0]
    mmap(..., buf.m.planes[0].length, ..., buf.m.planes[0].m.mem_offset);
} else {
    // Single-plane 映射
    mmap(..., buf.length, ..., buf.m.offset);
}
```
---

## 6. ISP (AIQ) 自动集成

传统的 V4L2 采集在没有 ISP 参与时，画面通常会非常暗。本项目已集成了 Rockchip 官方的 **AIQ (Artificial Intelligence Quality)** 处理模块。

### 核心机制
- **rk_isp_init**: 初始化 AIQ 库，加载 `/etc/iqfiles` 下的 IQ 配置文件。
- **Auto Exposure (AE)**: 自带线程实时计算曝光值，并反馈给驱动。
- **参数动态调节**: 支持通过 `rk_isp_set_brightness` 等接口实时调整画面亮度。

### 开发建议
- 程序启动时，若检测到 MIPI 节点，应调用 `rk_isp_init(0, NULL)`。
- 程序结束时，务必调用 `rk_isp_deinit(0)` 以释放资源。
- 更多详细逻辑请参考 `src/common/isp/isp.c`（官方源码，不可修改）。
