# RV1126 视频监控推流系统项目规划

## 1. 项目概述
本项目旨在基于 Rockchip RV1126 平台开发一套嵌入式视频监控推流系统。
**核心功能**：采集摄像头数据 -> 硬件 H.264 编码 -> RTMP 推流。
**目标参数**：支持双码流（1080p + 720p）。

## 2. 建议工程目录结构
为了保证代码的可维护性和模块化，建议采用以下目录结构：

```text
rv_demo/
├── build/                  # 编译构建目录（自动生成）
├── docs/                   # 项目文档与资料
│   └── reference.txt       # 原目标及参考资料
├── include/                # 头文件目录（对外接口）
│   ├── common/             # 通用定义（错误码、配置结构体）
│   ├── capture/            # 视频采集模块接口
│   ├── encoder/            # 视频编码模块接口
│   └── streamer/           # 推流模块接口
├── src/                    # 源代码目录
│   ├── main.c              # 主程序入口，负责线程调度
│   ├── common/             # 通用工具实现（线程安全队列、日志）
│   ├── capture/            # 摄像头采集实现 (RK MPI/VI)
│   ├── encoder/            # 视频编码实现 (RK MPP/VENC)
│   └── streamer/           # 推流实现 (FFmpeg/libavformat)
├── third_party/            # 第三方库（FFmpeg 等依赖库的头文件及静态库）
│   └── ffmpeg/
├── scripts/                # 辅助脚本
│   ├── build.sh            # 编译脚本
│   └── deploy.sh           # 部署/运行脚本（adb push 等）
├── CMakeLists.txt          # 主 CMake 配置文件
└── NOTE.md                 # 开发笔记/日志
```

---

## 3. 模块功能划分

### 3.1 基础/公共模块 (src/common)
- **日志系统**：统一的日志打印宏，便于调试。
- **线程安全队列**：用于在采集、编码、推流线程之间传递数据帧。
- **配置管理**：加载或定义分辨率、帧率、码率等参数。

### 3.2 视频采集模块 (src/capture)
- **职责**：调用 RK SDK (VI 模块) 或 V4L2 接口。
- **通过**：配置 MIPI CSI 参数，获取 NV12/YUV 数据。
- **输出**：原始 YUV 图像帧。

### 3.3 视频编码模块 (src/encoder)
- **职责**：调用 RK MPP (Media Process Platform) 库。
- **输入**：YUV 图像帧。
- **功能**：硬件 H.264 编码，支持多路编码（Channel 0: 1080p, Channel 1: 720p）。
- **输出**：H.264 NALU 数据包。

### 3.4 推流模块 (src/streamer)
- **职责**：集成 FFmpeg (libavformat, libavutil)。
- **输入**：H.264 数据包。
- **功能**：封装 FLV 容器，建立 RTMP 连接，发送数据包。
- **输出**：网络流至 RTMP 服务器 (如 Nginx-RTMP)。

---

## 4. 开发实施路线图 (Roadmap)

### 阶段一：环境搭建与基础框架 (Status:进行中)
- [x] 交叉编译环境验证 (Hello World)。
- [ ] 建立上述工程目录结构。
- [ ] 引入 `pthread` 多线程框架，编写简单的线程空跑测试。

### 阶段二：视频采集 (Capture)
- [ ] 学习 RV1126 VI (Video Input) 示例代码。
- [ ] 实现 `capture_init()` 和 `capture_get_frame()`。
- [ ] 验证：保存几帧 YUV 数据到文件，使用 YUV Player 查看由于是否正常。

### 阶段三：视频编码 (Encoder)
- [ ] 引入 Rockchip MPP 库。
- [ ] 实现 MPP 编码器初始化与销毁。
- [ ] 对接：Capture 线程将 YUV 送入 Encoder，Encoder 输出 H.264 文件。
- [ ] 验证：使用 VLC 播放生成的 .h264 文件。

### 阶段四：FFmpeg 推流 (Streamer)
- [ ] 交叉编译 FFmpeg (libavformat, libavcodec, libavutil) 并放入 `third_party`。
- [ ] 实现 FFmpeg RTMP 推流初始化。
- [ ] 封装 H.264 NALU 为 AVPacket (注意处理 SPS/PPS)。
- [ ] 联调：Capture -> Encoder -> Queue -> Streamer -> RTMP Server。

### 阶段五：性能优化与双流完善
- [ ] 开启双路编码 (1080p + 720p)。
- [ ] 优化线程同步锁，减少拷贝。
- [ ] 压力测试与长时间运行稳定性验证。

---

## 5. 关键技术点备注
- **内存共享**：尽量在 MPP 编码时使用 Zero-Copy 机制（dma_buf），减少 CPU 拷贝 YUV 数据的开销。
- **线程同步**：采集生产速度与网路推流速度可能不匹配，需要合理的丢帧策略（Drop Frame）。
- **SPS/PPS 处理**：RTMP 推流时，必须在关键帧（IDR）前发送 seq header (SPS+PPS)，或者在封装 FLV 头部时正确设置 `extradata`。
