# 📡 流媒体架构与数据流说明

本文档详细说明了本项目如何实现“一源多用”的流媒体架构，即如何基于同一路视频源同时支持 RTSP 局域网预览与 RTMP 云端推流，并介绍灵活的主/子码流配置策略。

---

## 🏗️ 整体数据流架构图

本项目采用 **多线程流水线 + 消息队列** 的设计，实现了采集、编码与推流的完全解耦。

### 1. 详细处理流水线 (Pipeline)
该图展示了数据从传感器捕获到分发至不同协议的完整硬件与软件路径：

```mermaid
graph TD
    subgraph 硬件处理层 (Hardware)
    Sensor[摄像头传感器] -- 原生数据 --> ISP[Rockchip ISP]
    ISP -- 图像增强 --> VI[视频输入 VI]
    end

    subgraph 编码处理层 (Mpp/Vpu)
    VI -- "Bind (零拷贝驱动级绑定)" --> VENC[硬件编码器 VENC]
    VENC -- "生成 H.264/H.265 帧" --> Buffer[编码码流缓冲区]
    end

    subgraph 软件流水线 (video.c)
    EncThread[编码线程] -- "从 VENC 获取数据" --> Queue[帧队列 FrameQueue]
    Queue -- "异步分发 (缓冲网络抖动)" --> PushThread[推流线程]
    end

    subgraph 协议分发层 (Multicast)
    PushThread -- "if(enable_rtsp)" --> RTSP_Lib[RTSP Server]
    PushThread -- "if(enable_rtmp)" --> RTMP_Lib[RTMP Client]
    end

    subgraph 外部终端
    RTSP_Lib -. "拉流 (Pull)" .-> VLC[VLC / ffplay]
    RTMP_Lib -- "推流 (Push)" --> Cloud[云端平台 / CDN]
    end

    style Queue fill:#f9f,stroke:#333,stroke-width:2px
    style VENC fill:#69f,stroke:#333,stroke-width:2px
```

### 2. 双码流并行分发图
本项目支持主、子两路码流并行工作，逻辑结构如下：

```mermaid
graph LR
    Camera((Camera)) --> VI{VI 通道}
    
    VI --> VENC_0[主码流 VENC 0]
    VI --> VENC_1[子码流 VENC 1]
    
    subgraph Stream_0 (Main)
    VENC_0 --> P0[推流线程 0]
    P0 --> RTSP0[RTSP /live/0]
    P0 --> RTMP0[RTMP Cloud]
    end
    
    subgraph Stream_1 (Sub)
    VENC_1 --> P1[推流线程 1]
    P1 --> RTSP1[RTSP /live/1]
    P1 --> RTMP1[RTMP Cloud]
    end
```

---

## ⚙️ 核心机制图解

### 1. 帧复用机制 (Frame Reuse)
这是实现“一源多用”的关键。`PushThread` 在处理每一路视频流时，不会为不同协议复制多份内存，而是采用如下逻辑：
- **Dequeue**: 从队列中提取一帧编码后的 H.264/H.265 数据。
- **Action A**: 如果配置开启了 RTSP，则调用打包函数将此帧送入 RTSP 发送缓冲区。
- **Action B**: 如果配置开启了 RTMP，则直接将**同一块内存地址**的数据传给 RTMP 封装库。
- **Release**: 只有当所有开启的协议都发送完毕后，才会释放该帧的内存。

### 2. 配置驱动模型 (Config-Driven)
系统不再硬编码业务逻辑，而是根据 `config.h` 中的宏定义生成的 `VideoConfig` 结构体进行运行：
- **动态启停**：初始化时遍历 `APP_MAX_STREAMS`，仅对有业务开启（RTSP 或 RTMP 为 1）的流启动相关线程。
- **按需分配**：如果某路流只开启 RTMP，则该路流的 RTSP 打包逻辑将完全不执行，节省 CPU 开关开销。

---

## 🆚 协议特性与应用场景

| 特性 | RTSP (局域网预览) | RTMP (云端直播) |
| :--- | :--- | :--- |
| **工作角色** | **服务端 (Server)** | **客户端 (Client)** |
| **主要路径** | 设备 -> 电脑播放器 | 设备 -> 云服务器 -> 观众 |
| **延迟表现** | **极低 (200-500ms)** | **一般 (1-3s)** |
| **网络要求** | 同一局域网或 VPN | 只要能上互联网即可 |
| **典型用途** | 实时调试、工程预览、NVR接入 | 远程直播、移动端APP查看 |

---

## 📺 验证与播放

### 1. RTSP 地址
- 主流: `rtsp://<开发板IP>/live/0`
- 子流: `rtsp://<开发板IP>/live/1`

### 2. RTMP 地址
- 地址完全由用户在 `APP_RTMP_URL` 中指定的第三方平台地址决定。