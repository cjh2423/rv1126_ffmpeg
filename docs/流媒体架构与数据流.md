# 📡 流媒体架构与数据流说明

本文档详细说明了本项目如何实现“一源多用”的流媒体架构，即如何基于同一路视频源同时支持 RTSP 局域网预览与 RTMP 云端推流。

---

## 🏗️ 1. 整体架构与数据流向

本项目采用 **多线程流水线 + 消息队列** 的设计，实现了采集、编码与推流的解耦。

### 核心流水线图解

```text
  [ 硬件层 ]              [ 软件层 (video.c) ]                [ 协议分发层 ]
 ┌─────────┐
 │ Sensor  │ 摄像头
 └────┬────┘
      │ (Raw Data)
      ▼
 ┌─────────┐
 │   ISP   │ 图像处理
 └────┬────┘
      │
      ▼
 ┌─────────┐            ┌───────────────────┐               ┌───────────────────┐
 │   VI    │ 视频输入    │    RGA (可选)     │  加速处理     │    编码线程       │
 │(Capture)├───Bind────►│  (Resize/Crop)    │ ────────────► │  (Venc Thread)    │
 └─────────┘ (零拷贝)    └───────────────────┘               └────┬──┬─────────┘
                                                                  │  │ OSD (Overlay)
                                                                  │  ▼
                                                                  │ (H.264/H.265 数据)
      ┌────────────────────────────▼──────────────────────────┐
      │                  帧队列 (Frame Queue)                 │
      │           (缓冲作用，平滑网络抖动对编码的影响)          │
      └────────────────────────────┬──────────────────────────┘
                                   │ (Dequeue)
                                   ▼
                        ┌───────────────────┐             ┌─────────────────────┐
                        │    推流线程       │ ----------> │   Monitor (Perf)    │
                        │   (Push Thread)   │ <---------- │  CPU/Mem/Temp/FPS   │
                        └─────────┬─────────┘             └─────────────────────┘
                                  │ (帧复用: 一次获取，多次分发)
                  ┌───────────────┴────────────────┐
                  ▼                                ▼
       [如果开启 RTSP]                      [如果开启 RTMP]
 ┌─────────────────────────┐          ┌─────────────────────────┐
 │      RTSP Server        │          │      RTMP Client        │
 │    (局域网实时预览)       │          │     (云端直播推流)      │
 └────────────┬────────────┘          └────────────┬────────────┘
              │                                    │
              ▼                                    ▼
       ┌─────────────┐                      ┌─────────────┐
       │ VLC/ffplay  │                      │  云直播平台  │
       │ (PC/手机)   │                      │ (B站/阿里)  │
       └─────────────┘                      └─────────────┘
```

---

## 🔄 2. 双码流并行架构

系统支持同时处理两路完全独立的视频流（主码流与子码流），互不干扰。

```text
 ┌─────────┐
 │ Camera  │
 └────┬────┘
      │
      ├─── [VI 通道 0] ───► [VENC 0] ──► [推流线程 0] ──┬─► RTSP (/live/0)
      │    (1080P)         (主码流)                     └─► RTMP (云端 A)
      │
      └─── [VI 通道 1] ───► [VENC 1] ──► [推流线程 1] ──┬─► RTSP (/live/1)
           (VGA/720P)      (子码流)                     └─► RTMP (云端 B)
```

---

## ⚙️ 3. 核心机制说明

### 3.1 帧复用 (Frame Reuse)
这是实现高效多协议分发的关键。推流线程从队列中取出一帧数据后：
1.  **判断 RTSP**: 如果开启，直接引用该帧数据内存，打包发送。
2.  **判断 RTMP**: 如果开启，**直接复用同一块内存地址**，封装为 FLV 标签发送。
3.  **释放**: 只有当两个协议都处理完毕（或跳过）后，才释放该帧内存。

> **优势**: 避免了为支持多协议而进行额外的内存拷贝或重新编码，极大降低 CPU 和内存开销。

### 3.2 动态配置 (Config-Driven)
系统在启动时会读取配置文件（或宏定义），**按需启动**相关服务：
*   若某路流只开启了 RTSP，系统**不会**初始化 RTMP 相关的网络连接。
*   若某路流完全关闭，系统**不会**创建对应的编码和推流线程，完全节省资源。

---

## 🆚 4. 协议对比

| 特性 | RTSP (局域网预览) | RTMP (云端直播) |
| :--- | :--- | :--- |
| **工作角色** | **服务端 (Server)** | **客户端 (Client)** |
| **传输方向** | 客户端(VLC)来 **拉流** | 设备主动往外 **推流** |
| **延迟** | **极低** (200-500ms) | **一般** (1-3s) |
| **网络要求** | 同一局域网或 VPN | 能上互联网即可 |
| **典型用途** | 调试、监控预览 | 直播、远程观看 |

---

## 📺 5. 验证指南

### 5.1 验证 RTSP
1.  确保电脑和开发板在同一路由器下。
2.  使用 **VLC 播放器** -> "打开网络串流"。
3.  输入地址：`rtsp://<开发板IP>/live/0` (主码流) 或 `/live/1` (子码流)。

### 5.2 验证 RTMP
1.  获取一个有效的推流地址（例如 B站直播间推流码）。
2.  在 `main/config/config.h` 中填入该地址。
3.  编译并运行程序。
4.  在直播网页或 VLC 中观看对应的直播流。
